<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="UTF-8"/><title>Call routing</title><meta name="generator" content="Adobe RoboHelp 2019"/><link rel="stylesheet" href="../assets/css/default.css"/><link rel="stylesheet" href="../assets/css/PortaBilling_Admin_Guide_MR82.css"/></head><body><div><h2><a id="_Routing_Plan_Selection"></a><a id="_Toc133593932"></a><a id="_Toc31205427"></a>Call routing</h2><p>When an entity on your network (for instance, a gateway or a SIP server) has to establish an outgoing call, it must find out where the call is being sent to. To do this, it can use its internal configuration (for example, dial-peer on the gateway) or some external entity (e.g. gatekeeper), or it may ask billing for a list of possible routes. This last method has several advantages: the routing configuration is in one central location, and billing can use information about termination costs to choose the best route (least-cost routing). </p><p> </p><p>Thus, for SIP calls, PortaSIP® obtains the routing information directly from billing.</p><p> </p><p>Control of routing on the Cisco gatekeeper (via GKTMP) or other equipment is not currently supported, but you can develop your own routing interface for PortaBilling®, which will communicate with PortaBilling® using RADIUS and then transfer this information to the originator in the correct format.</p><h3>High-level routing overview</h3><p>The following happens after the customer making the call has already been identified, the phone number has been translated into E.164, and all the required authorization checks have been performed:</p><ul data-start="260" xmlns=""><li>If the call is made to one of the access numbers for IVR applications, route the call to the PortaSIP® Media server and launch the IVR application. </li><li>If the call is for one of the phone numbers provisioned in the system (there is an account with an account ID identical to the dialed number), direct the call to the PortaSIP® server where the SIP phone is currently registered. Also, provide a list of routes for follow-me numbers or a voice mailbox, so that the call can be redirected there if the SIP phone is not currently available (off-line, not answering, etc.).</li><li>Otherwise, route the call to one of the gateways for termination, according to the routing rules specified in PortaBilling®.<h3>Routing of SIP on-net (SIP-to-SIP) calls</h3><p>As the first step in routing calculations, PortaBilling® checks if there is an account with an account ID equal to the dialed number (given in E.164). If such an account is found, it is clear that the call is designated for one of the subscribers provisioned on the system. PortaBilling® then extracts the latest known location for this account from the location database, in order to determine which PortaSIP® server the account is currently registered on, and routes the call there. The SIP server maintains information about all currently registered SIP user agents, so it is able to properly communicate with the SIP user agent handling this number.</p><h3>Routing of off-net calls</h3><p>You can have different vendors for terminating off-net calls. For example, you can terminate calls to the US either to AT&amp;T, via a T1 connected to your gateway in New York, or to a remote gateway from Qwest. </p><h4>Rate routing parameters</h4><p>Ordinarily, tariffs define the termination costs for each connection to a vendor. If you create a tariff with the Routing type, a few more fields will be added to rates in that tariff:</p></li><li>Route category – You can split rates into categories such as “Premium,” “Cheap,” etc. and use these categories in routing plans.</li><li>Preference – Routing priority (0–10), higher values mean higher priority, 0 means do not use this rate for routing at all. </li><li>Huntstop – Signals that no routes with a lower route category or preference should be considered.<p> </p><p>This allows you to easily manage both termination costs and routing from a single location on the web interface. Thus, when such a routing tariff is associated with a connection, you can send calls for termination to all prefixes for which rates exist in the tariff.</p><h4>Multiple routes</h4><p>It is dangerous to have only one termination partner: if it is down, your customers will not be able to make any calls. Normally, you will try to find several vendors and enter their rates into the system. Each connection to a vendor (with routing tariff) will produce one possible route, and PortaBilling® will arrange these according to cost or your other preferences, thus providing fail-over routing.</p><h4>Least cost routing</h4><p>Least cost routing (LCR) is the method for computing routing lists based solely on vendors’ cost. Thus, if you decide not to use any routing preferences (all vendors have the same preference), when a user makes a call, the LCR routing list will have the routes ordered by price from lowest to highest. </p><p> </p><p>Compare the two illustrations below. The first one shows simple least-cost routing: all of the available carriers are arranged according to cost. In the second illustration, PortaSwitch® routing preferences are used, so that the administrator can re-arrange the routing. In this case, carrier D has been moved down the routing list, while carrier A has been moved up to the top of the list, thus becoming the first route.</p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image184.png" width="1328.8" height="536.9" alt="Routing simulation"/></p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image185.png" width="1321.8" height="543.9" alt="Routing preferences"/></p><h3>Routing plans</h3><p>Routing preferences in the rate allow you to specify that, for example, you would rather send a call to MCI than to T-Systems. However, this decision is “global”, and so will apply to all calls made in your system. But what if you would like to use MCI first for customer A, while T-Systems should be the first route for customer B, and customer C should be routed to MCI only?</p><p> </p><p>This can be accomplished using routing plans. A routing plan is a combination of route categories in a specific order. It defines which categories of vendors are available for termination as well as in which order they should be arranged (route categories with a higher order value are tried first). For instance, in the example above MCI may be assigned as the “Normal” route category and T-Systems as the “Premium” category. After that, three routing plans will be created:</p></li><li>Quality – Includes first “Premium” and then “Normal” route categories.</li><li>Ordinary – Includes first “Normal” and then “Premium” route categories.</li><li>Cost-efficient – Includes only “Normal” route category.</li></ul><p> </p><p>Thus, the system will offer a different set of routes depending on which routing plan is assigned to the account making a phone call. One routing plan, called All Available Routes, is always in the system, and is assigned to the account unless otherwise specified. This routing plan uses all available routes, regardless of their route category.</p><h4>Route sorting</h4><p>How exactly does PortaBilling® arrange multiple available routes?</p><ol data-start="1" xmlns=""><li>By route category. Only route categories which are included in the routing plan will be used, following the order given in the routing plan. </li><li>If you have multiple route categories within the routing plan, you can either merge them into the same group by assigning them the same order value, or keep each one separate, with its own order value. Then routes within the same order group of route categories will be arranged according to preference.</li><li>For routes with the same preference, the system can arrange them according to cost (a comparison is made on the Price_Next rate parameter) so that cheaper routes will be among the first ones, or in random fashion.</li></ol><h4>Routing configuration example</h4><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image186.png" width="527.2" height="312.0" alt="Routing scheme"/></p><p> </p><p>Consider the following example. If you have:</p><ul data-start="269" xmlns=""><li>A “Standard” routing plan, which includes three route categories: “Default” (order 70), “Cheap” (order 40) and “Expensive” (order 10).</li><li>Six vendors (A, B, C, D, E, F) with the following rates (prefix, route category, preference, price):</li></ul><ol data-start="1" xmlns=""><li>8610, Cheap,       7, 0.04</li><li>86    , Default,     5, 0.06</li><li>86    , Cheap,       6, 0.03</li><li>86    , Cheap,       6, 0.025</li><li>86    , Expensive, 5, 0.11</li><li>8610 , Premium,  5, 0.09</li></ol><p> </p><p>then, when a customer with this routing plan makes a call to 8610234567, the system will arrange the possible routes as follows:</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:72px"/><col style="width:132px"/><col style="width:271.2px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Parameters</p></td><td><p>Comment</p></td></tr><tr><td><p>B</p></td><td><p>Default, 5, 0.06</p></td><td><p>The “Default” route category is first in the routing plan.</p></td></tr><tr><td><p>A</p></td><td><p>Cheap, 7, 0.04</p></td><td><p>This vendor has the highest preference in the “Cheap” category.</p></td></tr><tr><td><p>D</p></td><td><p>Cheap, 6, 0.025</p></td><td><p>This vendor has the same preference as vendor C, but a cheaper per-minute rate.</p></td></tr><tr><td><p>C</p></td><td><p>Cheap, 6, 0.03</p></td><td><p> </p></td></tr><tr><td><p>E</p></td><td><p>Expensive, 5, 0.11</p></td><td><p>This is the only vendor in the last route category.</p></td></tr></tbody></table></div><p> </p><p>(Vendor F was not included in the routing, since his route category is not in the customer’s routing plan).</p><h4>Routing plans with profit guarantee</h4><p>PortaBilling® supports a “profit-guarantee” mode for routing. If this mode is activated in a routing plan, all routes where the price per minute which your vendors apply to you is higher than that which you apply to your customers will be removed from the route list by the billing engine during real-time route calculation. Or, to put it in simpler terms, a route will not be selected if it is more expensive than what you charge your customers.</p><h4>Routing plan selection</h4><p>There are two possibilities for choosing which routing plan is used to find available vendors and terminate a call:</p><ul data-start="271" xmlns=""><li>Each account is assigned an individual routing plan. When the end user simply dials a number in the normal way, this routing plan will be used. </li><li>If the end user wants to choose a specific routing plan for a particular call, he dials a routing plan selection code before the number. <p> </p><p>For example, if he wants to use the “Premium” routing plan to call US phone number 12065551234, he would dial 23*12065551234, where 23* is the selection code defined as a property of the “Premium” routing plan.</p><h4>Selection codes</h4><p>The selection code is a property of a routing plan, and so obviously each routing plan has its own unique selection code. If you want to have a routing plan which cannot be specifically selected by an end user, simply leave the selection code field empty.</p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image187.png" width="461.5" height="147.9" alt="Edit routing plan_p"/></p><h4>Dialing rules</h4><p>By including a routing plan in the rating table definition in the product, you potentially allow every account with this product assigned to use this routing plan. If you want to prohibit a specific customer from selecting this routing plan for a call, you can disable it in the customer’s dialing rules. In that case, calls will be routed using the account’s default routing plan. </p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image188.png" width="461.5" height="224.7" alt="Routing plan configuration for dialing rules"/></p><h4>Required support outside PortaBilling®</h4><p>In order to be able to use dynamic routing plan selection and have these calls charged properly, adequate support is required on the switch side, i.e. the node which processes these calls. This derives from the fact that, although the customer initially dials the selection code, this information is not included in the phone number sent to the vendor, and therefore is not visible in the call accounting information. Therefore, the node must provide this information to PortaBilling® as a separate attribute, so that the call can be charged properly.</p><p> </p><p>PortaSIP® supports this functionality by default, while for switching equipment supplied by a third-party vendor it is recommended to consult with the vendor directly.</p><h3>Routing algorithm</h3><p>Based on the information above, the routing algorithm is as follows:</p></li><li>The SIP server (or some other entity) asks PortaBilling® for a list of routes for a given number. </li><li>PortaBilling® checks every tariff with routing extensions associated with a vendor connection to find rates matching this phone number. The best-matching rate is chosen in each tariff. This rate defines the routing parameters, i.e. it supplies a list of all vendors who can potentially terminate this call, including their cost and other related parameters.</li><li>A list of possible termination addresses will be produced (this will include remote IP addresses for VoIP connections and IP addresses of your own nodes with telephony connections).</li><li>This list will be sorted according to route category, routing preference and cost. Entries assigned a route category not included in the routing plan and entries which do not satisfy the profit-guarantee criteria will be removed. If some entry has a huntstop defined, entries that have a lower preference or route category will be ignored.</li><li>If there are several routes with an identical cost / preference, load sharing will be applied so that each potential route has an equal chance of being the first. Consequently, if your terminating carrier provides you with three gateways to send calls to, each gateway will, in the final analysis, receive approximately the same number of calls (33%).</li><li>If adaptive routing is used, then routes to vendors currently penalized for not meeting the quality criteria will be moved to the very last positions in the routing list.</li><li>A list of these IP addresses (with optional login and password for SIP authentication) will be returned to the SIP server. (To avoid extremely long call setup time, only a certain number of routes from the beginning of the list are returned; the default is 15, but this can be changed in the configuration).</li></ul><h3>Load balancing</h3><p>The routing list, computed according to the costs and preferences of individual vendors, is “static” – meaning that each vendor will always maintain his respective position in the list (first route, second route, last route, etc.) unless the vendor changes his cost or the administrator manually adjusts the preference for that vendor. Let’s look at the following example:</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:64.133333333333333333333333333px"/><col style="width:132px"/><col style="width:132px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Preference</p></td><td><p>Cost ($/minute)</p></td></tr><tr><td><p>A</p></td><td><p>5</p></td><td><p>0.05</p></td></tr><tr><td><p>B</p></td><td><p>5</p></td><td><p>0.06</p></td></tr><tr><td><p>C</p></td><td><p>5</p></td><td><p>0.15</p></td></tr></tbody></table></div><p> </p><p>In this case, after the sorting is done according to cost, Vendor A will occupy the first position in the list – and the first routing attempt will always be made to that vendor. Only if the call cannot be connected to Vendor A will it then be routed to Vendor B. This basically means that under normal circumstances, Vendor A will get most of the traffic, and a call will be routed to Vendor B only if all available capacity of Vendor A has been exceeded or if there is some temporary problem with connecting the call. Although this scheme offers maximum profit, conducting business this way is usually undesirable in real life. If the cost of several routes is comparable, it is better to allow a portion of the traffic to go further down the routing list via other carriers (Vendor B in our example). This will ensure that the other routes are maintained in an active state, that there is a sufficient amount of data for producing quality reports and that your contracts with those vendors will not be canceled due to inactivity.</p><p> </p><p>The idea is to allow a portion of all traffic to be directed to the vendors who are further down the routing list – though of course, this can only be done if the cost difference between the vendors is acceptable. In our example, Vendor C has a price per minute of $0.15 – so this route should obviously not be mixed with those of Vendors A and B, since the difference in cost ($0.10/min) is unacceptable.  </p><p> </p><p>By setting up the load balancing threshold in the routing plan, the administrator specifies the maximum acceptable difference in cost between two carriers, thereby indicating when routes to these carriers can potentially start “swapping” positions in the routing list.</p><p> </p><p>How does this value affect the route sorting in exact terms? After the list of potential routes is produced, but before the actual route re-arrangement according to cost takes place, each route cost is slightly changed by a random value. The adjusted cost may be increased or decreased compared to the original one, but the spread between the minimum possible value and the maximum possible value will be specified as the load balancing threshold. </p><p> </p><p>For instance, when the load balancing threshold is set to $0.02, then Vendor A’s cost ($0.05) may be increased or decreased by $0.01 (one half of $0.02), changing the cost to a random value between $0.04 and $0.06. Naturally this adjusted cost is purely fictional; these changes would only take effect during the sorting of routes and would not affect the actual call billing.</p><p> </p><p>As a result of these cost fluctuations, when the list of routes is sorted according to cost, the route sequence “shuffles” and the probability of two routes swapping places increases when they have similar prices. If in our example, above, we set the load balancing threshold to $0.02, the adjusted cost of A would be in the range of $0.04 and $0.06, and the adjusted cost for B would be in the range of $0.05 and $0.07. If for instance, the new cost of A happens to be $0.053 and the adjusted cost for B happens to be $0.052 – Vendor B would move into the first route position.</p><p> </p><p>Overall, in about 25% of all cases both values would be randomly distributed in the same range ($0.05-$0.06) and therefore, B would become the first route for about 12,5% (25% / 2) of all call attempts. In comparison, if B’s cost were $0.051 – this algorithm would result in B receiving an almost equal share (49.5%) of all calls that A is receiving, since adjusted cost values for A and B would be randomly distributed throughout two nearly 100% overlapping intervals ($0.04-$0.06 and $0.041-$0.061) and thus each vendor would have nearly the same chance of his adjusted cost being the lowest.</p><p> </p><p>This process of randomly adjusting the cost followed by re-arrangement is done for every new call. So for each call the actual routing list may look slightly different from previous lists and the overall call volume is properly distributed among multiple vendors.</p><p> </p><p>Note that load-balancing only applies to routes with the same preference and route category that have been assigned the same order in the routing plan. This is to prevent load-balancing (when undesirable) by simply increasing or decreasing the preference of a specific route. So if in our example the route to Vendor A has a preference of 6 and the route to Vendor B still has a preference of 5 – load-balancing would not happen, and A would remain in the first route position.</p><h3>Routing and connection utilization </h3><p>Aside from the price difference, another important consideration when arranging multiple routes is the number of already connected calls for a particular connection and the maximum number of calls it can potentially handle. Without this, a connection to a carrier may become overloaded, resulting in decreased sound quality and a higher number of failed call attempts, etc., while other carriers with just a slightly higher price may be underutilized. </p><p> </p><p>This is why PortaBilling® offers you the ability to factor in connection utilization when computing the routing list and perform load balancing among multiple connections accordingly. Load-balancing based on connection utilization may change route precedence even in cases where the price difference between vendors is too high for normal load-balancing (as described earlier).</p><p> </p><p>For each connection, the administrator defines two parameters: the maximum connection capacity and the load threshold (on PortaBilling® web interface it is the Start Utilization Balancing After attribute).</p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image189.png" width="430.1" height="407.1" alt="Connection capacity"/></p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image190.png" width="618.5" height="605.7" alt="Load balancing"/></p><p> </p><p>As long as the number of connected calls remains below the load threshold, the connection is considered to be operating in normal mode (sufficient available capacity), and calls are routed to this connection based solely on cost and assigned preferences (if the load-balancing threshold is defined, the shuffling of routes with similar prices may also take place). </p><p> </p><p>If the number of simultaneous calls established via the connection exceeds the load threshold, the connection is considered to have surpassed the desired limit and therefore some of the load shifted to other carriers that possess an acceptable price difference. This is done using an algorithm similar to the one used for load-balancing (described in the previous chapter). The administrator sets the overload handicap parameter (defined per routing plan) that specifies how far above the desired limit a load may “weigh down” the connection. A portion of this value (proportional to the actual load on the connection) is added to the route cost during route sorting so that the vendor’s cost (whose route was the first ‘unconditional’ route due to its lower price) now becomes comparable with the other vendors’ costs, and load-balancing can commence.</p><p> </p><p>If the connection load increases even further, the added “handicap” value increases as well. The calculated vendor’s cost (that is used during sorting) would rise higher and higher, leaving less chance for this vendor to be the first route.</p><p> </p><p>Finally, when the quantity of calls in progress reaches the maximum connection capacity threshold, this connection becomes excluded from the routing process; no further calls will be routed there until some already connected calls are disconnected.</p><p> </p><p>Let’s extend the example used for load-balancing to consider connection utilization. There are three vendors:</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:64.133333333333333333333333333px"/><col style="width:79.86666666666666666666666667px"/><col style="width:179px"/><col style="width:128.2px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Cost </p></td><td><p>Maximum Capacity</p></td><td><p>Load Threshold</p></td></tr><tr><td><p>A</p></td><td><p>$0.05</p></td><td><p>100</p></td><td><p>75</p></td></tr><tr><td><p>B</p></td><td><p>$0.07</p></td><td><p>250</p></td><td><p>150</p></td></tr><tr><td><p>C</p></td><td><p>$0.10</p></td><td><p>150</p></td><td><p>100</p></td></tr></tbody></table></div><p> </p><p>The routing plan setup is as follows:</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:258.73333333333333333333333333px"/><col style="width:53.266666666666666666666666667px"/></colgroup><tbody><tr><td><p>Parameter</p></td><td><p>Value</p></td></tr><tr><td><p>Load-balancing threshold</p></td><td><p>0.01</p></td></tr><tr><td><p>Overload handicap</p></td><td><p>0.05</p></td></tr></tbody></table></div><p> </p><p>Initially, when the load across all connections is minimal, the routing order is determined only by the vendor’s cost. Since the difference in cost is more than the allowed load-balancing threshold ($0.01), the routing order will always be Vendor A, Vendor B and then Vendor C.</p><p> </p><p>How does the situation change when some connections surpass the desired load limit?</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:60px"/><col style="width:48px"/><col style="width:76px"/><col style="width:82.4px"/><col style="width:69.6px"/><col style="width:72px"/><col style="width:67.2px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Cost </p></td><td><p>Max. Capacity</p></td><td><p>Load Threshold</p></td><td><p>Current Load</p></td><td><p>Handicap</p></td><td><p>Adjusted Cost</p></td></tr><tr><td><p>A</p></td><td><p>0.05</p></td><td><p>100</p></td><td><p>75</p></td><td><p>83</p></td><td><p>0.016</p></td><td><p>0.066</p></td></tr><tr><td><p>B</p></td><td><p>0.07</p></td><td><p>250</p></td><td><p>150</p></td><td><p>30</p></td><td><p>0</p></td><td><p>0.07</p></td></tr><tr><td><p>C</p></td><td><p>0.10</p></td><td><p>150</p></td><td><p>100</p></td><td><p>5</p></td><td><p>0</p></td><td><p>0.10</p></td></tr></tbody></table></div><p> </p><p>As you can see, Vendor A has exceeded the desired load capacity (75, specified by the load threshold) by 32%. This is calculated as the ratio of total number of calls above the desired capacity against the difference between desired and maximum capacity, in this case (83 – 75) / (100 – 75). So 32% of the overload handicap ($0.05 * 32% = $0.016) is added to Vendor A’s cost and the adjusted cost becomes $0.066. Since the difference between Vendor A’s and B’s costs is less than the load balancing threshold, load-balancing will commence and some percentage of calls will be routed to Vendor B. Let’s continue the example and assume that Vendor A’s load has increased even further:</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:60px"/><col style="width:48px"/><col style="width:76px"/><col style="width:82.4px"/><col style="width:69.6px"/><col style="width:72px"/><col style="width:67.2px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Cost </p></td><td><p>Max. Capacity</p></td><td><p>Load Threshold</p></td><td><p>Current Load</p></td><td><p>Handicap</p></td><td><p>Adjusted Cost</p></td></tr><tr><td><p>A</p></td><td><p>0.05</p></td><td><p>100</p></td><td><p>75</p></td><td><p>90</p></td><td><p>0.03</p></td><td><p>0.08</p></td></tr><tr><td><p>B</p></td><td><p>0.07</p></td><td><p>250</p></td><td><p>150</p></td><td><p>155</p></td><td><p>0.0025</p></td><td><p>0.0725</p></td></tr><tr><td><p>C</p></td><td><p>0.10</p></td><td><p>150</p></td><td><p>100</p></td><td><p>10</p></td><td><p>0</p></td><td><p>0.10</p></td></tr></tbody></table></div><p> </p><p>Since Vendor A’s load is approaching the maximum allowed limit, they are penalized even further – now with an adjusted cost of $0.08. Vendor B’s cost is also starting to be adjusted. Since it is only 5 calls above the load threshold, it is quite low compared to the maximum potential number of calls above the load threshold, which is 250 – 150 = 100 calls. So the overutilization is 5 / 100 = 5%, and thus the handicap effect is minimal ($0.05 * 5% = $0.0025). Now Vendor B will actually become the first route for the majority of calls, since its adjusted cost ($0.0725) is lower than Vendor A’s ($0.08).</p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:60px"/><col style="width:48px"/><col style="width:76px"/><col style="width:82.4px"/><col style="width:69.6px"/><col style="width:72px"/><col style="width:67.2px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Cost </p></td><td><p>Max. Capacity</p></td><td><p>Load Threshold</p></td><td><p>Current Load</p></td><td><p>Handicap</p></td><td><p>Adjusted Cost</p></td></tr><tr><td><p>A</p></td><td><p>0.05</p></td><td><p>100</p></td><td><p>75</p></td><td><p>98</p></td><td><p>0.046</p></td><td><p>0.096</p></td></tr><tr><td><p>B</p></td><td><p>0.07</p></td><td><p>250</p></td><td><p>150</p></td><td><p>200</p></td><td><p>0.025</p></td><td><p>0.0925</p></td></tr><tr><td><p>C</p></td><td><p>0.10</p></td><td><p>150</p></td><td><p>100</p></td><td><p>20</p></td><td><p>0</p></td><td><p>0.10</p></td></tr></tbody></table></div><p> </p><p>When the load on both Vendors A and B increases, their adjusted costs increase to the point that Vendor C also begins to participate in the load-balancing. </p><p> </p><div align="left"><table border="1.3" cellspacing="0"><colgroup xmlns=""><col style="width:60px"/><col style="width:48px"/><col style="width:76px"/><col style="width:82.4px"/><col style="width:69.6px"/><col style="width:72px"/><col style="width:67.2px"/></colgroup><tbody><tr><td><p>Vendor</p></td><td><p>Cost </p></td><td><p>Max. Capacity</p></td><td><p>Load Threshold</p></td><td><p>Current Load</p></td><td><p>Handicap</p></td><td><p>Adjusted Cost</p></td></tr><tr><td><p>A</p></td><td><p>0.05</p></td><td><p>100</p></td><td><p>75</p></td><td><p>100</p></td><td><p>0.046</p></td><td><p>N/A</p></td></tr><tr><td><p>B</p></td><td><p>0.07</p></td><td><p>250</p></td><td><p>150</p></td><td><p>230</p></td><td><p>0.04</p></td><td><p>0.11</p></td></tr><tr><td><p>C</p></td><td><p>0.10</p></td><td><p>150</p></td><td><p>100</p></td><td><p>20</p></td><td><p>0</p></td><td><p>0.10</p></td></tr></tbody></table></div><p> </p><p>And finally, when the load on Vendor A’s connection reaches the maximum allowed limit, this connection will be excluded from call routing. All further call attempts will be routed to Vendors C and B (with C becoming the first route because of its lower adjusted cost).</p><h3>Routing override</h3><p>Sometimes it is necessary to make minor adjustments to one or several routes. This configuration can be done with the help of the Routing Override functionality for individual routing plans. </p><p> </p><p>For example, a pool of connections is created in which 70% of the calls should go to carrier A, 20% to carrier B and 10% to carrier C. Suppose that the system has a total of 1,000,000 minutes. The administrator expects that 700,000 minutes will go to carrier A, 200,000 minutes to B and 100,000 minutes to C.</p><p> </p><p>In order to achieve this, the system will randomly change the routing list for each call and place one of them in first place according to the specified percentages. If you look at the statistics at the end of the day, you see that you obtained the required ratio. </p><p> </p><p>Once you have determined which route will be in first place, you will decide what to do with the other routes. Therefore, there are two cases of routing override that are configured using the pool:</p><ul data-start="280" xmlns=""><li>All routes are on the routing list, and all will be used for calls, thereby reducing the number of failed calls.</li><li>Only the first route is used for all calls, the other routes are ignored. <p> </p><p>Several types are used for configuring the pool of connections:</p></li><li>Consistent routing to one carrier (e.g. traffic to Vietnam-Mobile from customer A always goes to carrier XYZ).</li><li>Sequential routing – The administrator creates a list of connections for a destination group in a desired routing order, and calls are routed according to this sequence, before (or instead of) applying “normal” LCR routing. An entry in the override list can be a percentage-share connection pool, where each connection has a chance to be the first route, proportionate to the assigned percentage value (e.g. 25 percent of cases send traffic via the connection Europe Premium, 40 percent of cases send via the connection Termination to UK, and the rest (35 percent), are sent based on LCR). <p> </p><p>The configuration examples for the above-mentioned types of routing override can be found in the <a href="http://www.portaone.com/resources/documentation/index.htm">Unified PortaSwitch Handbook Collection</a>.</p><h3>Routing margin tariff</h3><p>In some cases, setting a single profit margin for all destinations is not flexible enough for obtaining the best results. For example, the service can be profitable when a service provider sells it to customers at “10% above the carrier’ price” but market research shows that certain destinations can be charged a higher rate and customers will buy the service anyway. The service provider sets a higher price for such destinations (e.g. 25% above the standard carrier’s price), and now wants to exclude those carriers that produce less profit from the routing. </p><p> </p><p>PortaBilling® supports routing margin tariffs that offer service providers an opportunity to maximize their profits. A routing margin tariff is a special tariff to be used instead of a real customer tariff exclusively in order to compare carriers’ prices against it. Only carriers having prices lower than or equal to those specified in this tariff will be selected for routing.  </p><p> </p><p>Consider the following example: </p><p> </p><p>An administrator is configuring the profit-guarantee settings and sets the minimum profit to 10%, specifying that it must be calculated based on the routing margin tariff.  </p><p> </p><p>The user calls a number in the UK, 44125551155. According to the user’s product, the regular rate for destination 4412 is $0.40. If there were no routing margin tariff defined, PortaBilling® would use those carries whose price for this destination is either lower than or equal to $0.40 – 10% = $0.36.  </p><p> </p><p>However, the routing margin tariff is set so PortaBilling® first checks whether there is a rate for 4412. PortaBilling® finds the rate for this destination defined as $0.10 so only carriers having a price for 4412 of $0.10 – 10% = $0.9 and lower will participate in the routing.  </p><p> </p><p>A regular customer tariff is used then solely to charge the customer. However, if a certain destination is not present or is prohibited in the routing margin tariff, the price from the regular customer tariff is used for calculating the profit-guarantee outcome. </p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image191.png" width="1323.8" height="491.9" alt="Routing simulation"/></p><h3>Adaptive routing</h3><p>PortaBilling® allows you to automate the process for controlling the call quality which becomes increasingly important today. That is, if you want to evaluate acceptable vendors for terminating VoIP calls, there is no need to hire numerous human operators or network engineers, who will track and analyze the specific route. All you need is to implement adaptive routing model.</p><p> </p><p>The main idea of adaptive routing is to dynamically measure a vendor’s quality parameters, and adjust the routing priority accordingly. These quality requirements are predefined in the form of threshold parameters on the Routing criteria page, and are then automatically applied to specific vendors. Any vendor who fails to satisfy your quality requirements will go to the “penalty box” – the very bottom of the routing list. This means that the system will try first to terminate calls using other carriers (with a good quality evaluation). However, if all of them fail or are unavailable, the “penalized” carrier will have a chance to terminate the call. It is still better to send a call via an inferior vendor than to have it fail completely. </p><p> </p><p>Thus, if the quality requirements are applied, a carrier’s place on the routing list is determined not only by the route category, the assigned preference value, and the cost parameters (LCR model), but additionally by quality criteria.</p><p> </p><p>For effective quality measurement, the following key control parameters are used:</p></li><li>ASR (Average Success Rate) – The number of successfully connected calls divided by the total number of call attempts.</li><li>PDD (Post Dial Delay) – The time interval between the connection request to a vendor and ring-back.</li><li>ALOC (Average Length of Call).</li><li>PPM (Profit per Minute) – The aggregated profit, i.e. the difference between the actual charged amounts in the CDRs for your customers and vendors. <p> </p><p>Each of the above parameters requires two values, which define the warning and penalty thresholds, respectively. When the value of a parameter reaches the predetermined threshold, the administrator receives an email alert about the latest connection threats. Moreover, the administrator can track the current connection status on the Tracking page. This status is represented by different colors, as follows:</p></li><li><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image192.png" width="17.0" height="17.0" alt="online_grey"/> GREY – The number of calls is not enough to apply filtering differentiation.</li><li><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image193.png" width="17.0" height="17.0" alt="online_green"/> GREEN – The route meets the quality requirements.</li><li><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image194.png" width="17.0" height="17.0" alt="online_yellow"/> YELLOW – The route is active, but some of its quality parameters are outside the warning thresholds.</li><li><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image195.png" width="17.0" height="17.0" alt="blocked"/> BLOCKED – This route is currently being penalized. <p>NOTE: The penalized route will stay in the “penalty box” for the period of time specified in Penalty Time, and then will be unblocked automatically. Alternatively, you can unblock the penalized route manually by clicking the Unblock Now button.</p></li><li><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image196.png" width="17.0" height="17.0" alt="online_red"/> RED – The route was manually unblocked; this status will remain until the next time interval for computing statistics.<h3>Routing to an external media gateway</h3><p>A common situation is when several different carriers are connected via PRI trunks (or SS7 interface) to the same media gateway, which does the conversion from VoIP to PSTN. When a call is sent to the gateway, the question is which particular carrier should be used to connect this particular phone call (or if multiple carriers are used – in which order should they be tried)?</p><p> </p><p>Most of the gateways support configuration of routing for outgoing calls via dial-peers or similar method, where the outgoing carrier or trunk group is chosen based on matching the dialed number (e.g. 4471555123456) to a set of prefixes (e.g. 447 or 4471) assigned to outgoing trunks. So it is possible to maintain the routing configuration on the gateway, but it is not taking into consideration the costs of sending calls to a particular vendor, and any change in the routing requires manual re-programming of the routing table on the gateway. Needless to say, this method significantly increases the amount of work for the administrator, reduces routing flexibility and is very likely to generate routing errors, which could seriously damage revenue of the service provider, since calls are not being sent to the carrier with lowest costs.</p><p> </p><p>So another approach is recommended: the media gateway is configured with the bare minimum of the routing information. Each outgoing carrier (or trunk group) is assigned its own prefix (e.g. 123# for carrier A and 456# for carrier B). When PortaSIP® sends a call to media gateway, it appends the specific carrier’s prefix to the dialed number, so only that carrier is used to transport this call (as illustrated below).</p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image197.png" width="537.6" height="294.4" alt="Routing via media GW"/></p><p> </p><p>As a result, the call routing is controlled at the single location, and one has to maintain a single set of carrier rates and related configuration.</p><h3>Routing in a multi-node scenario</h3><p>Sometimes a network consists of multiple nodes (for instance, if you have two PortaSIP® servers installed), each of them capable of doing call routing under the control of PortaBilling®. In this case, two scenarios are possible:</p></li><li>The node which receives the original call from the customer proceeds with routing of the call and delivers it to the “destination” carrier. This is the simplest scenario, and usually it provides the best results in terms of your network’s usage (since the call always travels the shortest possible path, with a minimum number of hops on the network). In this case, though, each node communicates with the carrier directly, which may require additional maintenance activities on your side (e.g. if the carrier uses authorization by IP address, you will need to provide him with a list of all your nodes’ IP addresses and keep that list updated as your network changes).</li><li>The node which receives the original call from the customer does the authorization (to verify the identity of the caller) and sends the call over to the “master” node. The master node then obtains the actual list of routes for this call and establishes the connection to the terminating carrier.<p> </p><p>The last scenario increases traffic within your network, but it allows you to handle advanced scenarios – for instance, when you have multiple PortaSIP® nodes deployed in different countries (and their IP addresses change often), but only your central PortaSIP® node, located in your main collocation facility, is able to communicate with the carrier because of IP address restrictions. </p><h4>Routing to carriers, which only support H323</h4><p>If the number of H323-only carriers is not too high, it would make sense to configure the system as follows:</p><p> </p><p>You can use Cisco IPIPGW, or any of the SBCs available on the market as a SIP-H323 convertor. The idea is to configure it in such a way that any incoming SIP call where the destination number starts with a certain tech-prefix will be sent out to a particular carrier. For example, if the destination number in the incoming call starts with 1#, the call will go out to IP address 6.7.8.9 (SuperNet); if the destination number starts with 2#, to IP address 1.2.3.4 (X-Telecom); and so on. Although this converter is (strictly speaking) part of your network, there is no need in this case to define it as a node in PortaBilling®, since it will not be exchanging any information via RADIUS.</p><p> </p><p>In PortaSwitch® you will configure your SIP carriers as usual. When you create a connection for an H323 carrier, you will specify the IP address of your SIP-H323 converter as the Remote IP Address and then assign a tech-prefix to this connection. In this way, although calls for multiple carriers will go from PortaSwitch® to the same IP address, the system can still recognize which carrier is used in each case.</p><p> </p><p>Let’s consider the following example for a better illustration of how this process works. Assume you have 4 carriers, all capable of terminating calls to the UK. Their respective rates per minute are: carrier A – 0.02, carrier B – 0.03, carrier C – 0.05 and carrier D – 0.10. Carriers B and D are H323 only, so for them connections are configured on the SIP-H323 converter (with IP address 192.168.0.3), with tech-prefix 2# and 4#, respectively. </p><p>A customer dials phone number 4412345678. The call arrives to the PortaSIP® node, which, upon successful authorization, receives the following routing list: </p><p> </p><p>Route 1: 4412345678 @ &lt;IP address of carrier A&gt;</p><p>Route 2: 2#4412345678 @ 192.168.0.3</p><p>Route 3: 4412345678 @ &lt;IP address of carrier C&gt;</p><p>Route 4: 4#4412345678 @ 192.168.0.3</p><p> </p><p>PortaSIP® will first try to establish a connection via the first route and, if that fails, it will send the call via the second route, to the SIP-H323 converter, which in turn will attempt to establish the call with carrier B. If a connection is not possible, after receiving an error message from the converter PortaSIP® will try the next available route, and so on.</p><p> </p><p>This method of configuration allows the SIP-H323 converter resource to be used only when it is actually required (since SBCs are usually licensed on a per-port basis), thus minimizing total network infrastructure costs.</p><h3>Intelligent routing on a third-party media gateway / SBC</h3><p>A common situation faced by service providers today is when a piece of communications equipment on the network (VoIP/TDM switch, media gateway, SBC, etc. – referred to below as the switch) is not capable of doing real-time call authorization or intelligent call routing like PortaSwitch®. How can you still perform call processing on such equipment in conjunction with the advanced call control and routing options that PortaSwitch® offers?</p><p></p><p> </p><p>In this scenario, the most straightforward method would be the following:</p></li><li>The switch is configured to accept an incoming call initiation request and send it to PortaSIP®.</li><li>PortaSIP® receives an incoming call and sends a request to PortaBilling® to perform caller authorization and obtain the routing list.</li><li>If authorization fails, the call disconnect command is sent back to the switch, and the incoming call on the switch is dropped.</li><li>In case of successful authorization, PortaBilling® computes the routing list (using LCR, preferences, settings in the customer’s individual routing plan, the current status of adaptive routing information for carriers, etc.). The resulting list of routes is delivered to PortaSIP®, which then starts processing them. If there is a carrier directly connected to the switch, PortaSIP® sends the call back to the switch, adding a tech-prefix to the destination number to indicate the specific trunk group this call should be routed to. If the first route fails, another call is sent to the switch (indicating a different trunk group), and so on. When the call is established, PortaSIP® acts as a signaling-only node, so there is no effect on the codecs, sound quality, or other voice media attributes. Finally, when the maximum allowed time has been reached, PortaSIP® sends a call disconnect request to the switch.</li></ul><p> </p><p>This allows the use of call authorization, advanced real-time routing and control of the customer’s credit limit, even with equipment which does not directly support these options.</p></div></body></html>