<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="UTF-8"/><title>xDR Mediation concept</title><meta name="generator" content="Adobe RoboHelp 2019"/><link rel="stylesheet" href="../assets/css/default.css"/><link rel="stylesheet" href="../assets/css/PortaBilling_Admin_Guide_MR82.css"/></head><body><div><h2><a id="_xDR_Mediation_–"></a><a id="_xDR_Mediation_concept"></a><a id="_Toc31205452"></a>xDR Mediation concept</h2><p><a id="xDR_creation"></a>Administrators can import CDRs to PortaBilling® from various external sources by using the xDR Mediation utility. The utility extracts the CDRs from incoming files and arranges the ready for processing CDRs into collections. PortaBilling® calculates the charges for these CDRs according to defined rates, and then based on this information, creates transaction records (also called xDRs). The created xDRs are then associated with corresponding accounts and vendors.</p><p> </p><p>Service providers face the necessity to import CDRs into PortaBilling® when their telecom partners deliver CDRs to them in one of several file formats or when the legacy equipment used does not support RADIUS and can only save CDRs to files. The ability to import CDRs in such cases helps to ensure accounting and reporting integrity. It eases the limitations on the equipment that can be used and allows the service provider to extend the pool of potential business partners.  </p><h3>xDR Mediation capabilities</h3><ul data-start="1.390" xmlns=""><li><ul data-start="1.390"><li>CDRs can be imported to PortaBilling® from .csv, fixed-width, TAP3 files, and from ASN1 files generated by Huawei MSoftX3000. </li><li>CDRs can be imported in chronological order based on a time stamp. This is the time when a billing event takes place (e.g. the connect time for a voice call). </li><li>It is possible to import CDRs for any types of services, for instance, voice calls, mobile and broadband data transfer or messaging.</li><li>PortaBilling® calculates the charges for imported CDRs. </li><li>Service providers may import xDRs that already contain charged amounts to PortaBilling®. In this case, import can be configured to forward these amounts to PortaBilling® as they are. Then PortaBilling® can apply an extra charge to the corresponding XDRs, if required. </li><li>Using Perl code, an administrator can define tailored data manipulation rules to apply to each type of source data. Created rules may, for example, translate CLD into E.164 format. Complex transformations can be executed as a custom module. </li><li>Several partial CDRs can be merged into a single logical CDR or one CDR can be split into several (i.e. to create separate call records for calling and called parties when calls are made within the same IP Centrex). </li><li>An administrator can check in real time whether CDRs are imported and rated successfully. In case there are issues with any of them, the administrator can adjust the extraction or rating configuration and re-run the process. <h3>xDR mediation process</h3><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image229.png" width="461.5" height="456.4" alt="xDR_mediation_"/></p><p> </p><p>Let’s have a look at the xDR import process step by step: </p></li><li>The input file with CDRs is saved to the incoming folder (1). When several files are added to the folder they are automatically placed in an alphanumerical order.</li><li>The queue manager that constantly monitors the incoming folder sees the file, checks that it is not a duplicate and queues it for processing.</li><li>Once queued, the Extraction utility creates an empty CDR collection – a set of CDR records from one or several files – in the interim data storage (referred to as collections’ storage).</li><li>The Extraction utility reads the file content and parses the data records (2). When parsed, each CDR is represented as a set of attribute-value pairs.</li><li>The Extraction utility moves the processed file to the archive location and (optionally) compresses it (3). </li><li>Then the Extraction utility performs the required data manipulation on the parsed CDRs according to the rules defined by the administrator (4).<p> </p></li><li>User-Name=18005551155</li><li>Acct-Session-Id=01010101</li><li>Calling-Station-Id=18005551155</li><li>Called-Station-Id=18005555555</li><li>Acct-Session-Time=65</li><li>h323-connect-time=02:15:03.000 UTC Mon Dec 23 2014</li><li>h323-remote-address=111.111.111.11</li><li>PortaOne-Service-Type=Voice</li><li>aggregation_key=11111<p> </p></li><li>The Extraction utility checks whether any records have the same aggregation key, and if so, merges these records (5). </li><li>When the file is processed (a delay period ends or the timer fires), the Extraction aggregates the ready-to-import CDRs and adds them to the collection (6). </li><li>The Rating utility monitors (7) the collections’ storage.</li><li>When the collection is updated, the Rating sends CDRs to the billing engine via RADIUS (8).</li><li>PortaBilling® authorizes the user, calculates the charges for the CDRs according to defined rates, if required, and then saves the created xDRs to the main database. </li><li>The Rating utility receives information about the import status (success, fail) (9).</li><li>The Rating utility updates the information in the collections’ storage (10). </li><li>An administrator can control the import process via web interface, and in case of mistakes, adjust the extraction or rating settings and re-run the import (11). <h3>xDR mediation modes</h3><p>How you receive files with CDR records depends on the peculiarities of your business and your agreements with your carrier. For example, your carrier sends you:</p></li><li>one file per day, or </li><li>one file every 30 minutes, etc. <p> </p><p>For this reason, you can import CDRs from one or several files to PortaBilling® in different modes:</p></li><li>sequential mode (the files are imported one by one) – For example, you upload three files to an incoming folder (e.g. A, B and C). The xDR Mediator processes the CDR records from each file and passes the CDRs to the billing engine for rating, file by file. </li><li></li><li>Here, the Extraction utility processes the CDRs from each file and creates a separate CDR collection for each of them (e.g. collection A, collection B, etc.). The Rating utility processes the CDRs from collection A and sends them to the billing server in chronological order. The Rating utility then processes the CDRs from collection B, etc. </li><li></li><li>consolidated mode (the data from several files is collected and then imported) – For example, the same files, A, B, and C are in the incoming folder. </li><li></li><li>In this case, the Extraction utility creates a single collection for the CDR records from all the files. It processes the CDRs from each file and waits for 60 minutes by default. At the end of this time, the Extraction utility updates the collection and places ready-to-import CDRs to be rated. The Rating utility processes the CDRs from the collection and sends them to the billing engine in chronological order.<p>NOTE:  Both sequential and consolidated modes enable you to import CDRs in chronological order. These modes require the use of one Extraction utility and one Rating utility. The number of simultaneous flows depends on the productivity of your system.</p></li><li>random mode (several files are simultaneously processed) – For example, some files (e.g. A, B, C and D) are in the folder. The xDR Mediator processes the A, B, and C files at the same time and passes the CDRs to the billing engine for rating.</li><li></li><li>In this case, several Extraction and Rating utilities operate with source files. It is difficult to predict the order of data import since the size of the files and their process time may differ. </li></ul></li></ul><h3><a id="_Hlk510188178"></a>Auto-download of xDR files from external systems</h3><p>The xDR mediator has built-in functionality for communicating with external systems (IMS, third-party gateways, etc.) to receive CDR source files via the FTP / SFTP protocols.</p><p> </p><p>The xDR mediator can operate as either an FTP client or an FTP server. </p><p>When it operates as an FTP client, it connects to the external system and downloads CDR source files via FTP / SFTP.  To make this happen, the administrator defines the credentials necessary for accessing the external system as well as the path to the folder from which to download the files.</p><p> </p><p>When operating as an FTP server, the procedure is reversed. The administrator configures the entry point to the xDR mediator for the external system. The administrator creates a special user for the file transfer. The external system uses this user’s credentials to access the xDR mediator and upload the CDR source files to the specified folder.</p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image230.png" width="401.6" height="440.8" alt="Filetransfer user"/></p><p> </p><p>FTP file transfer (inbound or outbound) is the recommended configuration compared to other ones (e.g. via SCP or ssh access) since it increases system security and simplifies xDR mediator support through system updates.</p><h3><a id="_Hlk16849263"></a>Retroactive billing during xDR import</h3><p>To calculate charges for a billing session, PortaBilling® must consider the delay between the session’s effective time – the time when the session starts / is connected, and the charging time – the time actually charged. For real-time charging this delay is very short (only a couple of seconds). When it comes to xDR import, the delay can be considerable – several hours or even days (e.g. roaming xDRs can arrive several days after actual service usage). In the latter case, the billing periods that these charges and volume discount consumption refer to can already be closed. </p><p> </p><p>Therefore, to ensure correct charging for a closed billing period, PortaBilling® retroactively bills during an xDR import and uses the tariff applicable at the time the session started to produce the xDRs. The xDRs are then added to the open billing period.</p><p> </p><p>Volume discount usage is withdrawn from the closed billing period’s counters. </p><p> </p><p>Consider the following example:</p><p>Let’s say John Doe has a “100 free roaming minutes” monthly quota with one rollover. Throughout November he makes calls for 90 minutes in roaming and on December 1 his billing period closes. Thus, 10 minutes remain from the November quota. </p><p> </p><p>On December 2nd the roaming vendor sends you CDRs with John’s service usage for November 30, which includes 5 minutes of calls. Upon xDR import, these charges are applied to John’s November billing period and his quota counters for November are adjusted by 5 minutes. When John makes calls on December 3, his December quota now includes 105 minutes (5 minutes rolled over from November).</p><p>NOTE: If the quota has been used in the current billing period prior to xDR import for the previous one, the rollover from the previous billing period is not adjusted. Thus, if John makes a call on December 1, his rollover amount is 10 minutes.</p><p> </p></div><div><ul data-start="1.433" xmlns=""><li><ul data-start="1.433"><li><br/>‎<span></span></li></ul></li></ul><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><p> </p><h1><a id="_Toc31205453"></a>Billing / invoicing</h1><p> </p><p> </p><p><br/>‎<span> </span></p></div></body></html>