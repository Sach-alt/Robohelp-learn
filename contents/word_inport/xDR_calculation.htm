<?xml version="1.0" encoding="utf-8" ?>

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="UTF-8"/><title>xDR calculation</title><meta name="generator" content="Adobe RoboHelp 2019"/><link rel="stylesheet" href="../assets/css/default.css"/><link rel="stylesheet" href="../assets/css/PortaBilling_Admin_Guide_MR82.css"/></head><body><div><h2><a id="_Toc31205406"></a>xDR calculation</h2><p>PortaBilling® can collect information about the call via various network elements (e.g. PortaSIP® and the media gateway), combine the individual pieces and produce a single xDR record.</p><h4>Collecting data from the VoIP network</h4><p></p><p> </p><p>Gateways in the PortaBilling® owner network are “trusted” gateways. These gateways MUST be listed in the Nodes directory and be a RADIUS or Diameter client. </p><p> </p><p>Gateways which belong to your customers or vendors should not be created as nodes. Instead, a remote GW which belongs to your customer will be represented in the system as an account. </p><p> </p><p>If the termination GW transmits an accounting record (connection matched), the User-Name must be verified to see if a trusted GW (Node IP=User-Name) is calling. If so, then the billing engine must wait for an accounting record from the trusted GW and use the User-Name from a trusted GW accounting record. If a trusted GW is not found, the call will be charged immediately to an applicable account. If an account is not found, a “security breach” mail alert will be sent. </p><h3>Call legs</h3><p>Billing for telephony services is done based on the information provided by the elements of your VoIP network: gateways, SIP server, and so on. This information is supplied to the billing engine as accounting records. Usually the gateway treats incoming and outgoing calls as two separate entities, i.e. call legs. Each of the call legs produces a separate accounting record, so that, for instance, billing engine receives 4 accounting requests in case of a “classic” VoIP call arriving from PSTN to gateway A, traveling over the Internet to gateway B, and terminating in the PSTN network once again. Of course there must be some way of knowing that these four records are actually part of the same logical call. Therefore, each of them includes a special attribute that carries a unique ID for the call. This ID is used by the billing engine to add the call legs together, and is also extremely useful for troubleshooting. For H323 calls, this attribute is called h323-conf-id, while for SIP calls it is call-id (however, for backward compatibility Cisco gateways and PortaSwitch® assign a h323-conf-id for every SIP call). </p><h3>Extended xDRs for IP Centrex calls</h3><p>Owners of IP Centrex environments may wish to obtain information about the actions of particular extensions during “complex” calls, i.e. calls that consist of several call legs such as call transfer, call forwarding, etc. For example, you might want to know which extension transferred the call or for how long an operator actually spoke, so that this information can be used in statistics reports.</p><p> </p><p>PortaBilling® compliments xDRs for complex IP Centrex calls with auxiliary call details such as:</p><ul data-start="1.195" xmlns=""><li><ul data-start="1.195"><li>Which huntgroup a call came from.</li><li>What the last extension ID was that forwarded or transferred the call.</li><li>The actual call duration, i.e. the length of time an operator spoke in the call.</li><li>The caller identity from where the call originated.<p> </p><p>All of these details are available on the administrator web interface as part of the xDR history for a customer or their accounts. To browse auxiliary call details, click the Details icon next to the required xDR.</p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image144.png" width="461.5" height="204.8" alt="Call details"/></p><p> </p><p>The Voice call details dialog window displays:</p></li><li>The extension number to which the call was redirected.</li><li>Via – The extension or huntgroup number that dispatched the call.</li><li>Call duration – The time during which the owner of the account being billed was occupied.</li><li>Caller extension ID – The extension number where the call originated from.</li><li>Called extension ID – The extension number that accepted the call. </li><li>Calling party identity – The actual caller identity where the call originated from.<p> </p><p>Auxiliary call details are created for the following IP Centrex calls: </p></li><li>Calls to voicemail (direct and missed calls). </li><li>Forwarded / follow-me calls.</li><li>Call pick-up.</li><li>Transferred calls (via blind and attended transfer).<p> </p><p>This list is provided out of the box. However, it is easily scalable and in future releases will be extended to cover more call scenarios such as call queues, etc. </p><h4>External custom reports</h4><p>The auxiliary call details are defined by the following xDR fields: </p></li><li>via_hg – Information about the huntgroup that dispatched the call.</li><li>via_ext – Information about the last extension ID from where the call was forwarded or transferred.<p>NOTE: These flags appear when a call is processed within the IP Centrex environment.</p></li><li>media_duration – Information about the actual time the owner of the account to be billed was speaking during the call.</li><li>acli – Information about the actual caller identity within the IP Centrex environment from where the call originated. This identity may differ from the one delivered by the IP PBX (e.g. the IP PBX main account or the caller’s phone in case of forwarded calls) and displayed on the device of the called party.  <p> </p><p>These fields are added to the XDR_Auxiliary_Types table in the database while their values are stored in a separate XDR_Accounts_Aux table. The administrator can retrieve the information by accessing the database and can formulate a statistics report using a third-party application such as the Crystal Report tool. Please refer to the <a href="#_Custom_Reports">Custom Reports</a> section for details of the custom report creation.</p><p> </p><p>With extended xDRs you receive more sophisticated statistics data which helps you improve the IP Centrex management. The data may also serve as an additional tool for accounting.</p><h3><a id="_Hlk29368192"></a>Understanding Charged duration and Call duration in xDRs</h3><p>When viewing Voice call details in customer and account xDRs, you see two fields: Charged duration and Call duration. What are they and what’s the difference between the two? </p><p> </p><p><img src="../assets/images/PortaBilling_Admin_Guide_MR82_files/image145.png" width="1008.1" height="481.8" alt="Picture 281"/></p><p> </p><p>Charged duration is the total session duration. It is recorded in the charged_quantity xDR field. PortaBilling® uses this value to calculate charges for the corresponding account. (The account to bill for the session is stored in the User-Name attribute).</p><p> </p><p>Call duration is the time the user actually speaks. It is recorded in the media_duration xDR field and is mainly used for statistics purposes.</p><p> </p><p>In direct calls between users, these two field values may be equal. In complex calls such as call transfer, call forwarding, call pickup and calls that involve an IVR, they may differ. Let’s have a look at some examples:</p><h5>Example 1. Call forwarding</h5><p>An external caller Mary calls Bob. Bob has follow-me configured so the call is forwarded to Carol. Mary and Carol speak for 5 minutes. After the call ends, PortaBilling® produces the xDRs for the call participants:</p><p>Bob is charged for the incoming call from Mary. Since Bob forwarded the call to Carol and was not physically speaking but is the one to pay for this call, his xDR details include: </p></li><li>charged duration of 5 minutes, and </li><li>call duration of 0 minutes.<p> </p><p>Carol is charged for the incoming call from Bob. Her xDR details include:</p></li><li>charged duration of 5 minutes, and </li><li>call duration of 5 minutes.<h5>Example 2. Blind transfer</h5><p>Alice calls Bob. After 1 minute of conversation, Bob transfers the call to Carol. Carol answers and Bob is disconnected. Alice and Carol speak for 10 minutes.</p><p> </p><p>After the call is over, PortaBilling® produces the xDRs for call participants: </p></li><li>For Alice: the xDR for the outgoing call to Bob. The xDR has the charge for the whole call, which includes the call to Bob (for 1 minute) and the call to Carol (for 10 minutes). Thus, in xDR details for Alice we see charged duration and call duration equal 11 minutes. </li><li>For Bob: the xDR for the incoming call from Alice. The charged duration and call duration are 1 minute.</li><li>For Bob: the xDR for the redirected call to Carol. The charged duration is 10 minutes (Bob’s account is billed for the transfer) but the call duration is 0, since Bob did not participate in this conversation.</li><li>For Carol: for the incoming call from Alice. The charged duration and call duration are 10 minutes.<h5>Example 3. Call to a call queue via the auto-attendant</h5><p>Alice calls EasyCall. She dials 12065558899 – the auto-attendant for EasyCall. She presses 1 and is redirected to the Sales queue. After 2 minutes she’s connected to Peter, the sales agent. They speak for 7 minutes.</p><p> </p><p>After the call ends, PortaBilling® produces these xDRs:</p></li><li>For Alice – for the outgoing call to Pete. The xDR includes the charged duration and the call duration of 9 minutes (2 minutes for waiting in the queue and 7 minutes for the conversation). </li><li>For the auto-attendant account (12065558899) – for the redirected call from Alice to Pete. The charged duration is 9 minutes because the auto-attendant account is billed for the transfer to Pete. The call duration is 0 because the auto-attendant does not participate in the conversation.</li><li>For Pete – for the incoming call from the auto-attendant. The charged duration and the call duration equal 7 minutes.</li></ul></li></ul></div></body></html>